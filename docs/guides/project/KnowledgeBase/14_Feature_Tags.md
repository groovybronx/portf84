# Feature: Tags

**Directory**: `src/features/tags`

This feature handles the taxonomy system: Tags and Colors.

> **ðŸ“š For comprehensive technical documentation**, see:
> - [Tag System Guide](../../architecture/TAG_SYSTEM_GUIDE.md) - User guide
- [Tag System Architecture](../../architecture/TAG_SYSTEM_ARCHITECTURE.md) - Technical design
- [Tag System README](../../features/TAG_SYSTEM_README.md) - Feature overviewnce and common operations

## Components

### `TagManager` (`components/TagManager.tsx`)
A panel (usually inside Settings or a dedicated modal) to manage the global list of tags.
-   **Function**: Allows adding, removing tags with autocomplete suggestions.
-   **Features**: 
    - Alias detection with visual hints
    - Autocomplete from existing tags
    - Separate display for AI vs manual tags
-   *Status*: Enhanced implementation with alias support.

### `TagManagerModal` (`components/TagManagerModal.tsx`)
Smart Tag Fusion interface for consolidating similar tags.
-   **Function**: Detects and merges duplicate/similar tags
-   **Features**:
    - Automatic similarity detection (Levenshtein + Jaccard)
    - Individual and batch merge operations
    - Merge history tracking
    - Database resynchronization utility
-   *Status*: Full implementation.

### `AddTagModal` (`components/AddTagModal.tsx`)
A dialog to add tags to the current selection.
-   **Autocomplete**: Suggests existing tags from `LibraryContext.availableTags`.
-   **Creation**: Allows typing a new tag and pressing Enter.

## Storage Architecture

**Dual Persistence Strategy**:
The tag system uses both JSON and relational storage for reliability:

1. **JSON Storage** (Legacy/Backup): 
   - Tags stored as arrays in the `metadata` table
   - `aiTags`, `manualTags`, `aiTagsDetailed`

2. **Relational Storage** (Primary):
   - `tags` table: Unique tag definitions with normalization
   - `item_tags` table: Many-to-many relationships
   - `tag_merges` table: Merge history for audit trail
   - `tag_aliases` table: Synonym mappings for smart suggestions

## Tag Types

**AI vs Manual**:
The system distinguishes between:
-   `aiTags`: Generated by Gemini (High confidence).
-   `manualTags`: Added by user.
-   `aiTagsDetailed`: AI tags with confidence scores.
-   **UI**: AI tags have different style (gray) vs manual tags (blue).
-   **Search**: The search index includes both.

## Color Tags

A fixed set of 6 colors: Red, Orange, Yellow, Green, Blue, Purple.
-   Stored as string: `"red"`, `"blue"`, etc.
-   UI renders these as small dots on the `PhotoCard`.
-   Filtering: Clicking a color dot in the TopBar sets `activeColorFilter`.

## Multi-Tag Filtering (Phase 4.3)

**AND Logic Filtering**: The library now supports selecting multiple tags simultaneously to find items that have ALL selected tags.

**Implementation**:
- State changed from `selectedTag: string | null` to `activeTags: Set<string>`
- New actions: `toggleTag()`, `setActiveTags()`, `clearTags()`
- UI displays active tags as chips in the search field
- Filtered count shown in TopBar when filters active

**User Experience**:
- Click tags in Tag Hub to toggle them on/off
- Tag Hub stays open for multi-selection
- Individual chips can be removed via X button
- "Clear All Tags" button to reset filters

**Example**: Selecting "Portrait" + "Outdoor" shows only photos with both tags.

## Smart Tag Fusion

**Similarity Detection Algorithms**:
1. **Levenshtein Distance**: Detects typos and singular/plural variations
   - Examples: "landscape" â†” "landscapes", "portrait" â†” "portait"
   
2. **Jaccard Similarity**: Detects multi-word tag variations
   - Removes stop words ("and", "et", "the", "le", etc.)
   - Examples: "noir et blanc" â†” "noir blanc"

**Merge Process**:
- Consolidates all items from source tags to target tag
- Records merge in history for audit trail
- Supports both individual and batch operations
- Maintains data integrity with no loss of associations

## Usage Examples

```typescript
// Add a tag
const tagId = await getOrCreateTag('landscape', 'manual');
await addTagToItem(itemId, tagId);

// Find duplicates
const groups = await analyzeTagRedundancy();

// Merge tags
await mergeTags(targetTagId, [sourceId1, sourceId2]);

// Create alias
await createTagAlias('b&w', blackAndWhiteTagId);
```

## Testing

Comprehensive test suite with 41+ tests covering:
- Similarity detection algorithms
- Merge operations
- Alias management
- Edge cases and performance

Run tests: `npm test tests/tagSystem.test.ts`
