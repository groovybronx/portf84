name: Build Documentation Index

on:
  # Trigger on documentation changes
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/**/*.md'
      - 'scripts/rag/**'

  # Trigger on pull requests affecting documentation
  pull_request:
    paths:
      - 'docs/**/*.md'
      - 'scripts/rag/**'

  # Allow manual trigger
  workflow_dispatch:

  # Daily rebuild at 2:00 UTC
  schedule:
    - cron: '0 2 * * *'

jobs:
  build-index:
    name: Build Documentation Index
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better metadata

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Add any Python dependencies here if needed in the future
          echo "No additional dependencies required currently"

      - name: ðŸ”¨ Build documentation index
        run: |
          echo "Building documentation index..."
          python scripts/rag/build_doc_index.py

      - name: âœ… Validate generated JSON files
        run: |
          echo "Validating index files..."
          
          # Check that files were created
          if [ ! -f "docs/.doc-index.json" ]; then
            echo "âŒ Error: docs/.doc-index.json not generated"
            exit 1
          fi
          
          if [ ! -f "docs/.doc-metadata.json" ]; then
            echo "âŒ Error: docs/.doc-metadata.json not generated"
            exit 1
          fi
          
          # Validate JSON syntax
          python -c "import json; json.load(open('docs/.doc-index.json'))"
          python -c "import json; json.load(open('docs/.doc-metadata.json'))"
          
          echo "âœ… JSON files are valid"

      - name: ðŸ“Š Display index statistics
        run: |
          echo "ðŸ“Š Index Statistics:"
          python -c "
          import json
          with open('docs/.doc-metadata.json') as f:
              metadata = json.load(f)['metadata']
          print(f\"  Total documents: {metadata['total_documents']}\")
          print(f\"  Total sections: {metadata['total_sections']}\")
          print(f\"  Total words: {metadata['total_words']:,}\")
          print(f\"  Generated: {metadata['generated']}\")
          "

      - name: ðŸ’¾ Commit and push metadata
        if: github.event_name != 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add only the metadata file (not the full index)
          git add docs/.doc-metadata.json
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update documentation metadata [skip ci]"
            git push
            echo "âœ… Metadata committed and pushed"
          fi

      - name: ðŸ“¤ Upload index artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation-index
          path: |
            docs/.doc-index.json
            docs/.doc-metadata.json
          retention-days: 30

      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const metadata = JSON.parse(fs.readFileSync('docs/.doc-metadata.json', 'utf8'));
            const stats = metadata.metadata;
            
            const comment = `## ðŸ“š Documentation Index Updated
            
            The documentation index has been successfully rebuilt:
            
            - **Total documents**: ${stats.total_documents}
            - **Total sections**: ${stats.total_sections}
            - **Total words**: ${stats.total_words.toLocaleString()}
            - **Generated**: ${stats.generated}
            
            ### Priority Breakdown
            ${Object.entries(stats.priority_breakdown).map(([priority, count]) => 
              `- **${priority.charAt(0).toUpperCase() + priority.slice(1)}**: ${count}`
            ).join('\n')}
            
            ### Top Keywords
            ${stats.top_keywords.slice(0, 10).join(', ')}
            
            The RAG documentation agent can now access the latest documentation!
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ðŸ§ª Run tests
        run: |
          echo "Running RAG system tests..."
          python scripts/rag/test_rag_system.py

  verify-search:
    name: Verify Search Functionality
    runs-on: ubuntu-latest
    needs: build-index

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¥ Download index artifact
        uses: actions/download-artifact@v4.1.3
        with:
          name: documentation-index
          path: docs/

      - name: ðŸ” Test search queries
        run: |
          echo "Testing search functionality..."
          
          # Test various queries
          python scripts/rag/search_documentation.py "architecture" > /dev/null
          python scripts/rag/search_documentation.py "tags system" > /dev/null
          python scripts/rag/search_documentation.py "React components" > /dev/null
          
          echo "âœ… Search queries executed successfully"
