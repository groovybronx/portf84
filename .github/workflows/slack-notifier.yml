name: "Slack Notifications"

on:
  workflow_run:
    workflows: ["Enhanced Semantic Release"]
    types:
      - completed
  release:
    types: [published, created]

jobs:
  notify-slack:
    name: "Send Slack Notifications"
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Get workflow data
        id: workflow-data
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            WORKFLOW_RUN_ID="${{ github.event.workflow_run.id }}"
            WORKFLOW_CONCLUSION="${{ github.event.workflow_run.conclusion }}"
            WORKFLOW_STATUS="${{ github.event.workflow_run.status }}"

            echo "workflow_run_id=$WORKFLOW_RUN_ID" >> $GITHUB_OUTPUT
            echo "workflow_conclusion=$WORKFLOW_CONCLUSION" >> $GITHUB_OUTPUT
            echo "workflow_status=$WORKFLOW_STATUS" >> $GITHUB_OUTPUT
          else
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            RELEASE_NAME="${{ github.event.release.name }}"
            RELEASE_PRERELEASE="${{ github.event.release.prerelease }}"

            echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
            echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
            echo "release_prerelease=$RELEASE_PRERELEASE" >> $GITHUB_OUTPUT
          fi

      - name: Send release notification
        if: github.event_name == 'release'
        run: |
          echo "ðŸ“¢ Sending release notification to Slack..."

          # Determine message style based on release type
          if [[ "${{ steps.workflow-data.outputs.release_prerelease }}" == "true" ]]; then
            EMOJI="ðŸš€"
            COLOR="warning"
            TYPE="PrÃ©-release"
          else
            EMOJI="ðŸŽ‰"
            COLOR="good"
            TYPE="Release Stable"
          fi

          # Create detailed release message
          cat > slack_release.json << EOF
          {
            "attachments": [
              {
                "color": "$COLOR",
                "title": "$EMOJI $TYPE: ${{ steps.workflow-data.outputs.release_name }}",
                "title_link": "${{ github.event.release.html_url }}",
                "fields": [
                  {
                    "title": "Version",
                    "value": "${{ steps.workflow-data.outputs.release_tag }}",
                    "short": true
                  },
                  {
                    "title": "Type",
                    "value": "$TYPE",
                    "short": true
                  },
                  {
                    "title": "PubliÃ© par",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Date",
                    "value": "$(date '+%d/%m/%Y %H:%M')",
                    "short": true
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "ðŸ“¦ TÃ©lÃ©charger",
                    "url": "${{ github.event.release.html_url }}"
                  },
                  {
                    "type": "button",
                    "text": "ðŸ“‹ Release Notes",
                    "url": "${{ github.event.release.html_url }}"
                  }
                ],
                "footer": "Lumina Portfolio",
                "ts": $(date +%s)
              }
            ]
          }
          EOF

          echo "Slack release notification prepared"
          echo "Configure SLACK_WEBHOOK_URL to enable notifications"

          # Uncomment when Slack is configured
          # curl -X POST -H 'Content-type: application/json' \
          #   --data @slack_release.json \
          #   "${{ secrets.SLACK_WEBHOOK_URL }}"

      - name: Send workflow completion notification
        if: github.event_name == 'workflow_run'
        run: |
          echo "ðŸ“¢ Sending workflow completion notification to Slack..."

          # Determine message based on workflow conclusion
          case "${{ steps.workflow-data.outputs.workflow_conclusion }}" in
            "success")
              EMOJI="âœ…"
              COLOR="good"
              STATUS="SuccÃ¨s"
              ;;
            "failure")
              EMOJI="âŒ"
              COLOR="danger"
              STATUS="Ã‰chec"
              ;;
            "cancelled")
              EMOJI="â¹ï¸"
              COLOR="warning"
              STATUS="AnnulÃ©"
              ;;
            *)
              EMOJI="â“"
              COLOR="#cccccc"
              STATUS="Inconnu"
              ;;
          esac

          # Get workflow details
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ steps.workflow-data.outputs.workflow_run_id }}"

          cat > slack_workflow.json << EOF
          {
            "attachments": [
              {
                "color": "$COLOR",
                "title": "$EMOJI Workflow Release - $STATUS",
                "title_link": "$WORKFLOW_URL",
                "fields": [
                  {
                    "title": "Workflow",
                    "value": "Enhanced Semantic Release",
                    "short": true
                  },
                  {
                    "title": "Statut",
                    "value": "$STATUS",
                    "short": true
                  },
                  {
                    "title": "DÃ©clenchÃ© par",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "DurÃ©e",
                    "value": "$(date '+%H:%M:%S')",
                    "short": true
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "ðŸ” Voir les Logs",
                    "url": "$WORKFLOW_URL"
                  }
                ],
                "footer": "Lumina Portfolio",
                "ts": $(date +%s)
              }
            ]
          }
          EOF

          echo "Slack workflow notification prepared"
          echo "Configure SLACK_WEBHOOK_URL to enable notifications"

          # Uncomment when Slack is configured
          # curl -X POST -H 'Content-type: application/json' \
          #   --data @slack_workflow.json \
          #   "${{ secrets.SLACK_WEBHOOK_URL }}"

      - name: Send deployment notification
        if: github.event_name == 'release' && github.event.release.prerelease == 'false'
        run: |
          echo "ðŸ“¢ Sending deployment notification to Slack..."

          cat > slack_deploy.json << EOF
          {
            "attachments": [
              {
                "color": "#36a64f",
                "title": "ðŸš€ DÃ©ployment en Production",
                "title_link": "${{ github.event.release.html_url }}",
                "text": "La version ${{ steps.workflow-data.outputs.release_tag }} est maintenant disponible en production.",
                "fields": [
                  {
                    "title": "Version",
                    "value": "${{ steps.workflow-data.outputs.release_tag }}",
                    "short": true
                  },
                  {
                    "title": "Statut",
                    "value": "DÃ©ployÃ©",
                    "short": true
                  },
                  {
                    "title": "Assets",
                    "value": "Release assets",
                    "short": true
                  },
                  {
                    "title": "TÃ©lÃ©chargements",
                    "value": "Disponibles",
                    "short": true
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "ðŸ“¦ TÃ©lÃ©charger",
                    "url": "${{ github.event.release.html_url }}"
                  },
                  {
                    "type": "button",
                    "text": "ðŸŒ Site Web",
                    "url": "https://lumina-portfolio.com"
                  }
                ],
                "footer": "Lumina Portfolio",
                "ts": $(date +%s)
              }
            ]
          }
          EOF

          echo "Slack deployment notification prepared"
          echo "Configure SLACK_WEBHOOK_URL to enable notifications"

          # Uncomment when Slack is configured
          # curl -X POST -H 'Content-type: application/json' \
          #   --data @slack_deploy.json \
          #   "${{ secrets.SLACK_WEBHOOK_URL }}"
